{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/responsive.dataTables.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/dsmain.css' %}">
{% endblock %}

{% block script %}
<script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'js/jquery.dataTables.js' %}"></script>
<script src="{% static 'js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'js/buttons.html5.min.js' %}"></script>
{% endblock %}


{% block content %}
<body>
    <div class="wrap">
        <h1>Trading History</h1>
        <form>
                <div class="form-group" id="date_range">
                    <label for="date_range" >
                        Select range : &nbsp
                    </label>

                    <input type="radio" name="date_range" value="latest" checked> latest &nbsp</label>
                    <input type="radio" name="date_range" value="onehour"> 1 hour &nbsp</label>
                    <input type="radio" name="date_range" value="threehour"> 3 hour &nbsp</label>
                    <input type="radio" name="date_range" value="sixhour"> 6 hour &nbsp</label>
                    <input type="radio" name="date_range" value="day"> a day &nbsp</label>
                    <input type="radio" name="date_range" value="threeday"> 3 day &nbsp</label>
                    <input type="radio" name="date_range" value="week"> week &nbsp</label>
                    <input type="radio" name="date_range" value="month"> month &nbsp</label>
<!--                    <input type="radio" name="date_range" value="all"> all &nbsp</label>-->
                    <input type="button" class="btn btn-primary btn-lg" value="Loading" id="refresh">
                </div>

        </form>

        <table id="myTable" class="display" style="width:100%;">
            <thead>
                <tr>
                    <th>id</th>
                    <th>create</th>
                    <th>botname</th>
                    <th>exname</th>
                    <th data-orderable="false">type</th>
                    <th data-orderable="false">traded</th>
                    <th data-orderable="false">qty</th>
                    <th data-orderable="false">avg_price</th>
                    <th data-orderable="false">price</th>
                    <th>mark</th>
                    <th data-orderable="false">mode</th>
                    <th data-orderable="false">target</th>
                    <th data-orderable="false">payment</th>
                    <th data-orderable="false">status</th>
                    <th data-orderable="false">order</th>
                    <th data-orderable="false">bids_price</th>
                    <th data-orderable="false">asks_price</th>
                    <th data-orderable="false">fee</th>
                    <th data-orderable="false">order_id</th>
                </tr>
            </thead>
            <tfoot>
<!--                <tr>-->
<!--                    <th colspan="2" style="text-align:right;white-space:nowrap;">TOTAL : </th>-->
<!--                    <th colspan="4" style="text-align:left;white-space:nowrap;"></th>-->
<!--                </tr>-->
            </tfoot>
        </table>
    </div>
</body>

<script>
// 참고 문헌 https://datatables.net/

$('#refresh').click(function() {

    var table = $('#myTable').DataTable();
    table.destroy();
    date_range = $("input[name='date_range']:checked").val();
    if (typeof date_range == "undefined")
        date_range = 'latest';

    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex){
            var min = Date.parse($('#fromDate').val());
            var max = Date.parse($('#toDate').val());
            var targetDate = Date.parse(data[5]);

            if( (isNaN(min) && isNaN(max) ) ||
                (isNaN(min) && targetDate <= max )||
                ( min <= targetDate && isNaN(max) ) ||
                ( targetDate >= min && targetDate <= max) ){
                    return true;
            }
            return false;
        }
    )

    var table = $('#myTable').DataTable({
        "ajax" : {
            'url':"",
            'type': 'POST',
            'data' : {
                'csrfmiddlewaretoken' : '{{ csrf_token }}',
                'date_range': date_range,
            }
        },
        responsive: true,
        orderMulti: true,
        order : [[1, 'desc']],
        "columns": [
            {"data": "id"},
            {"data": "create"},
            {"data": "botname"},
            {"data": "exname"},
            {"data": "type"},
            {"data": "unit_traded"},
            {"data": "qty"},
            {"data": "avg_price"},
            {"data": "price"},
            {"data": "mark"},
            {"data": "mode"},
            {"data": "target"},
            {"data": "payment"},
            {"data": "status"},
            {"data": "order"},
            {"data": "bids_price"},
            {"data": "asks_price"},
            {"data": "fee"},
            {"data": "order_id"}
        ],
        "language": {
            "emptyTable": "데이터가 없어요.",
            "lengthMenu": "페이지당 _MENU_ 개씩 보기",
            "info": "현재 _START_ - _END_ / _TOTAL_건",
            "infoEmpty": "데이터 없음",
            "infoFiltered": "( _MAX_건의 데이터에서 필터링됨 )",
            "search": "에서 검색: ",
            "zeroRecords": "일치하는 데이터가 없어요.",
            "loadingRecords": "로딩중...",
            "processing":     "잠시만 기다려 주세요...",
            "paginate": {
                "next": "다음",
                "previous": "이전"
            }
        },
        /* Footer에 금액총합 구하기,
         * filtered data 총합만 계산하도록 함.*/
        "footerCallback":function(){
            var api = this.api(), data;
            var result = 0;
            api.column(7, {search:'applied'}).data().each(function(data,index){
                result += parseFloat(data);
            });
            $(api.column(3).footer()).html(result.toLocaleString()+'원');
        },
        dom : 'Blfrtip',
        buttons:[{
			extend:'csvHtml5',
			text: 'Export CSV',
			footer: true,
			bom: true,
			className: 'exportCSV'
		}]
    });

    /* Column별 검색기능 추가 */
    $('#myTable_filter').prepend('<select id="select"></select>');
    $('#myTable > thead > tr').children().each(function (indexInArray, valueOfElement) {
        $('#select').append('<option>'+valueOfElement.innerHTML+'</option>');
    });

    $('.dataTables_filter input').unbind().bind('keyup', function () {
        var colIndex = document.querySelector('#select').selectedIndex;
        table.column(colIndex).search(this.value).draw();
    });

    /* 날짜검색 이벤트 리바인딩 */
    $('#myTable_filter').prepend('<input type="text" id="toDate" placeholder="yyyy-MM-dd"> ');
    $('#myTable_filter').prepend('<input type="text" id="fromDate" placeholder="yyyy-MM-dd">~');
    $('#toDate, #fromDate').unbind().bind('keyup',function(){
        table.draw();
    })

});

$(document).ready(function () {

    date_range = $("input[name='date_range']:checked").val();
    if (typeof date_range == "undefined")
        date_range = 'latest';

    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex){
            var min = Date.parse($('#fromDate').val());
            var max = Date.parse($('#toDate').val());
            var targetDate = Date.parse(data[5]);

            if( (isNaN(min) && isNaN(max) ) ||
                (isNaN(min) && targetDate <= max )||
                ( min <= targetDate && isNaN(max) ) ||
                ( targetDate >= min && targetDate <= max) ){
                    return true;
            }
            return false;
        }
    )

    var table = $('#myTable').DataTable({
        "ajax" : {
            'url':"",
            'type': 'POST',
            'data' : {
                'csrfmiddlewaretoken' : '{{ csrf_token }}',
                'date_range': date_range,
            }
        },
        responsive: true,
        orderMulti: true,
        order : [[1, 'desc']],
        "columns": [
            {"data": "id"},
            {"data": "create"},
            {"data": "botname"},
            {"data": "exname"},
            {"data": "type"},
            {"data": "unit_traded"},
            {"data": "qty"},
            {"data": "avg_price"},
            {"data": "price"},
            {"data": "mark"},
            {"data": "mode"},
            {"data": "target"},
            {"data": "payment"},
            {"data": "status"},
            {"data": "order"},
            {"data": "bids_price"},
            {"data": "asks_price"},
            {"data": "fee"},
            {"data": "order_id"}
        ],
        "language": {
            "emptyTable": "데이터가 없어요.",
            "lengthMenu": "페이지당 _MENU_ 개씩 보기",
            "info": "현재 _START_ - _END_ / _TOTAL_건",
            "infoEmpty": "데이터 없음",
            "infoFiltered": "( _MAX_건의 데이터에서 필터링됨 )",
            "search": "에서 검색: ",
            "zeroRecords": "일치하는 데이터가 없어요.",
            "loadingRecords": "로딩중...",
            "processing":     "잠시만 기다려 주세요...",
            "paginate": {
                "next": "다음",
                "previous": "이전"
            }
        },
        /* Footer에 금액총합 구하기,
         * filtered data 총합만 계산하도록 함.*/
        "footerCallback":function(){
            var api = this.api(), data;
            var result = 0;
            api.column(7, {search:'applied'}).data().each(function(data,index){
                result += parseFloat(data);
            });
            $(api.column(3).footer()).html(result.toLocaleString()+'원');
        },
        dom : 'Blfrtip',
        buttons:[{
			extend:'csvHtml5',
			text: 'Export CSV',
			footer: true,
			bom: true,
			className: 'exportCSV'
		}]
    });

    /* Column별 검색기능 추가 */
    $('#myTable_filter').prepend('<select id="select"></select>');
    $('#myTable > thead > tr').children().each(function (indexInArray, valueOfElement) {
        $('#select').append('<option>'+valueOfElement.innerHTML+'</option>');
    });

    $('.dataTables_filter input').unbind().bind('keyup', function () {
        var colIndex = document.querySelector('#select').selectedIndex;
        table.column(colIndex).search(this.value).draw();
    });

    /* 날짜검색 이벤트 리바인딩 */
    $('#myTable_filter').prepend('<input type="text" id="toDate" placeholder="yyyy-MM-dd"> ');
    $('#myTable_filter').prepend('<input type="text" id="fromDate" placeholder="yyyy-MM-dd">~');
    $('#toDate, #fromDate').unbind().bind('keyup',function(){
        table.draw();
    })


});
</script>

{% endblock %}